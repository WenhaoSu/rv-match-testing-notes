# mawk

The source code of `mawk` can be found [here](https://invisible-island.net/mawk/).

### Summary

The potential issue is that `./configure` will generate a header file called `config.h`, but that generated by `gcc` is different from that generated by `kcc`.
`gcc`'s version gives
```c
#define mawk_rand random
#define mawk_srand srandom
```
but `kcc` gives
```c
#define mawk_rand arc4random
#define mawk_srand arc4random_push
```
We can not find where `arc4random` and `arc4random_push` are defined. However, if we use `random` and `srandom` for `kcc`'s `config.h`, this error would be thrown:
```
Fatal error: exception (Invalid_argument
  "convert_byte_to_native: encodedValue(opaque(#token(\"2\", \"Int\"), ut(`.Set`(.KList), structType(tag(`Identifier`(#token(\"\\\"_IO_FILE\\\"\", \"String\")), #token(\"\\\"/opt/rv-match/c-semantics/profiles/x86_64-linux-gcc-glibc/src/kcc_types.c55777c10-8fd5-11ea-9420-aad0e96ca077\\\"\", \"String\"), `global_C-TYPING-SYNTAX`(.KList))))), #token(\"0\", \"Int\"), #token(\"8\", \"Int\"))")
```

### Pre-request
```
wget https://invisible-island.net/datafiles/release/mawk.tar.gz
tar -xvzf mawk.tar.gz
rm mawk.tar.gz
```

### Build
Build with `gcc`:
```
./configure
make
```
Build with `kcc`:
```
./configure CC=kcc LD=kcc
make
```

### Test
Run `./mawk -f` on `awk` files in `examples/`, or run test shell scripts in `test/`, for example:
```
cd test/
bash mawktest
```

### Observation - Build

`kcc` succeeded in the `make` job.
One difference observed while compiling is that, for the `Makefile` auto-generated by `configure` file, `gcc` uses `-O2` flag while `kcc` does not. Also, `kcc` managed to report following undefined behaviors when compiling `execute.c` and `bi_funct.c`:
```
kcc -c -I. -I. -DHAVE_CONFIG_H  -DLOCAL_REGEXP -D_DEFAULT_SOURCE -D_XOPEN_SOURCE=500 -g  execute.c
execute.c:1095:6: error: A pointer (or array subscript) outside the bounds of an object.

    Undefined behavior (UB-CEA1):
        see C11 section 6.5.6:8 http://rvdoc.org/C11/6.5.6        
        see C11 section J.2:1 item 46 http://rvdoc.org/C11/J.2    
        see CERT-C section ARR30-C http://rvdoc.org/CERT-C/ARR30-C
        see CERT-C section ARR37-C http://rvdoc.org/CERT-C/ARR37-C
        see CERT-C section STR31-C http://rvdoc.org/CERT-C/STR31-C
        see MISRA-C section 8.18:1 http://rvdoc.org/MISRA-C/8.18  
        see MISRA-C section 8.1:3 http://rvdoc.org/MISRA-C/8.1    

execute.c:1095:6: error: Found pointer that refers outside the bounds of an object + 1.

    Undefined behavior (UB-CEE3):
        see C11 section 6.3.2.1:1 http://rvdoc.org/C11/6.3.2.1
        see C11 section J.2:1 item 19 http://rvdoc.org/C11/J.2
        see CERT-C section ARR30-C http://rvdoc.org/CERT-C/ARR30-C
        see CERT-C section ARR37-C http://rvdoc.org/CERT-C/ARR37-C
        see CERT-C section STR31-C http://rvdoc.org/CERT-C/STR31-C
        see MISRA-C section 8.1:3 http://rvdoc.org/MISRA-C/8.1

kcc -c -I. -I. -DHAVE_CONFIG_H  -DLOCAL_REGEXP -D_DEFAULT_SOURCE -D_XOPEN_SOURCE=500 -g  bi_funct.c
bi_funct.c:805:5: error: Trying to look up identifier arc4random_push, but no such identifier is in scope.

    Syntax error (SE-CID1):
        see C11 section 6.5.1:2 http://rvdoc.org/C11/6.5.1
        see CERT-C section DCL31-C http://rvdoc.org/CERT-C/DCL31-C

bi_funct.c:837:2: error: Trying to look up identifier arc4random, but no such identifier is in scope.

    Syntax error (SE-CID1):
        see C11 section 6.5.1:2 http://rvdoc.org/C11/6.5.1
        see CERT-C section DCL31-C http://rvdoc.org/CERT-C/DCL31-C

```


`gcc` took `0m9.129s` to finish `make`, while `kcc` took `3m6.887s`.

### Observation - Testing

While `gcc` compiled file can execute the test files normally in `test/`, `kcc` failed for both running files in `test/` folder and `example/` folder. Moreover, `kcc` compiled version even can't print the usage normally. When typing `./mawk -W usage`, `kcc` compiled version reports the following errors, which is quite long.
It can be observed that most of the error comes from `memory.c`, `hash.c`, and `bi_funct.c`, and the last error `No definition found for identifier arc4random_push` caused `kcc` to stop.
```
Type of lvalue (struct <anonymous at types.h:62>) not compatible with the effective type of the object being accessed (struct hash):
      > in xnew_STRING at memory.c:43:5
        in new_STRING at memory.c:90:2
        in bi_vars_init at bi_vars.c:81:6
        in initialize at init.c:72:5
        in main at main.c:47:5

    Undefined behavior (UB-EIO10):
        see C11 section 6.5:7 http://rvdoc.org/C11/6.5
        see C11 section J.2:1 item 37 http://rvdoc.org/C11/J.2
        see CERT-C section EXP39-C http://rvdoc.org/CERT-C/EXP39-C
        see MISRA-C section 8.1:3 http://rvdoc.org/MISRA-C/8.1

Type of lvalue (unsigned long) not compatible with the effective type of the object being accessed (struct hash):
      > in xnew_STRING at memory.c:43:5
        in new_STRING at memory.c:90:2
        in bi_vars_init at bi_vars.c:81:6
        in initialize at init.c:72:5
        in main at main.c:47:5

    Undefined behavior (UB-EIO10):
        see C11 section 6.5:7 http://rvdoc.org/C11/6.5
        see C11 section J.2:1 item 37 http://rvdoc.org/C11/J.2
        see CERT-C section EXP39-C http://rvdoc.org/CERT-C/EXP39-C
        see MISRA-C section 8.1:3 http://rvdoc.org/MISRA-C/8.1

Type of lvalue (struct <anonymous at types.h:62>) not compatible with the effective type of the object being accessed (struct hash):
      > in xnew_STRING at memory.c:44:5
        in new_STRING at memory.c:90:2
        in bi_vars_init at bi_vars.c:81:6
        in initialize at init.c:72:5
        in main at main.c:47:5

    Undefined behavior (UB-EIO10):
        see C11 section 6.5:7 http://rvdoc.org/C11/6.5
        see C11 section J.2:1 item 37 http://rvdoc.org/C11/J.2
        see CERT-C section EXP39-C http://rvdoc.org/CERT-C/EXP39-C
        see MISRA-C section 8.1:3 http://rvdoc.org/MISRA-C/8.1

...

Type of lvalue (const struct <anonymous at ./symtype.h:25> *) not compatible with the effective type of the object being accessed (struct hash):
      > in bi_funct_init at bi_funct.c:104:2
        in initialize at init.c:73:5
        in main at main.c:47:5

    Undefined behavior (UB-EIO10):
        see C11 section 6.5:7 http://rvdoc.org/C11/6.5
        see C11 section J.2:1 item 37 http://rvdoc.org/C11/J.2
        see CERT-C section EXP39-C http://rvdoc.org/CERT-C/EXP39-C
        see MISRA-C section 8.1:3 http://rvdoc.org/MISRA-C/8.1

No definition found for identifier arc4random_push:
      > in bi_srand at bi_funct.c:805:5
        in bi_funct_init at bi_funct.c:114:2
        in initialize at init.c:73:5
        in main at main.c:47:5

    Undefined behavior (UB-CID2):
        see C11 section 6.3.2.1:1 http://rvdoc.org/C11/6.3.2.1
        see C11 section J.2:1 item 19 http://rvdoc.org/C11/J.2
        see CERT-C section DCL31-C http://rvdoc.org/CERT-C/DCL31-C
        see MISRA-C section 8.1:3 http://rvdoc.org/MISRA-C/8.1

Execution failed (configuration dumped)
```

### Followup

If we run `../mawk -f wc.awk mawktest.dat` under `tests` folder, `gcc` would run normally and return the word count, while `kcc` fails to execute normally, and return the exactly same error message as above.

If we look deep into the error message, we can find that `kcc` is mainly complaining about the `Type of lvalue not compatible with the effective type of the object being accessed` error for following lines:
```
bi_vars_init at bi_vars.c:81:6
bi_vars_init at bi_vars.c:84:6
bi_vars_init at bi_vars.c:87:6

bi_funct_init at bi_funct.c:97:5
bi_funct_init at bi_funct.c:98:5
bi_funct_init at bi_funct.c:99:5
bi_funct_init at bi_funct.c:102:2
bi_funct_init at bi_funct.c:103:2
bi_funct_init at bi_funct.c:104:2
```
while the samiliar error message is reported several times. Take `bi_funct_init at bi_funct.c:99:5` as example (only difference is *Type of lvalue*):
```
Type of lvalue (struct <anonymous at ./symtype.h:85>) not compatible with the effective type of the object being accessed (struct hash):
      > in bi_funct_init at bi_funct.c:99:5
        in initialize at init.c:73:5
        in main at main.c:47:5

Type of lvalue (union <anonymous at ./symtype.h:85>) not compatible with the effective type of the object being accessed (struct hash):
      > in bi_funct_init at bi_funct.c:99:5
        in initialize at init.c:73:5
        in main at main.c:47:5

Type of lvalue (const struct <anonymous at ./symtype.h:25> *) not compatible with the effective type of the object being accessed (struct hash):
      > in bi_funct_init at bi_funct.c:99:5
        in initialize at init.c:73:5
        in main at main.c:47:5
```

and there is another type of error complaining about `No definition found for identifier arc4random_push` in:
```
bi_srand at bi_funct.c:805:5
```
---

Here is the function `bi_vars_init` in `bi_vars.c`

```c
void
bi_vars_init(void)
{
    register int i;
    register SYMTAB *s;

    for (i = 0; i < NUM_BI_VAR; i++) {
	s = insert(bi_var_names[i]);
	s->type = (char) ((i <= 1) ? ST_NR : ST_VAR);
	s->stval.cp = bi_vars + i;
	/* bi_vars[i].type = 0 which is C_NOINIT */
    }

    s = insert("ENVIRON");
    s->type = ST_ENV;

    /* set defaults */

    FILENAME->type = C_STRING;
    FILENAME->ptr = (PTR) new_STRING("");

    OFS->type = C_STRING;
    OFS->ptr = (PTR) new_STRING(" ");           // Line 81, error here

    ORS->type = C_STRING;
    ORS->ptr = (PTR) new_STRING("\n");          // Line 84, error here

    SUBSEP->type = C_STRING;
    SUBSEP->ptr = (PTR) new_STRING("\034");     // Line 87, error here

    NR->type = FNR->type = C_DOUBLE;
    /* dval is already 0.0 */

#if USE_BINMODE
    BINMODE->type = C_DOUBLE;
#endif
}
```

The root error for those lines related to the following two functions:
```
xnew_STRING at memory.c:43:5/44:5
new_STRING at memory.c:90:2/91.2
```
and below are the code for those two functions:
```c
STRING null_str = {0, 1, ""};

static STRING *
xnew_STRING(size_t len)
{
    STRING *sval = (STRING *) zmalloc(len + STRING_OH);

    sval->len = len;                        // Line 43, error here
    sval->ref_cnt = 1;                      // Line 44, error here
    return sval;
}

/* convert char* to STRING* */

STRING *
new_STRING(const char *s)
{

    if (s[0] == 0) {
	null_str.ref_cnt++;
	return &null_str;
    } else {
	STRING *sval = xnew_STRING(strlen(s));  // Line 90, error here
	strcpy(sval->str, s);                   // Line 91, error here
	return sval;
    }
}
```
while the struct of `STRING` is also defined by mawk at line 62 in `types.h`:
```c
typedef struct {
    size_t len;
    unsigned ref_cnt;
    char str[2];
} STRING;
```
The thing quite strange here is that, e.g., the first error message says:
```
Type of lvalue (struct <anonymous at types.h:62>) not compatible with the effective type of the object being accessed (struct hash):
      > in xnew_STRING at memory.c:43:5
```
but what does it mean here by saying `struct <anonymous at types.h:62>` (probably it is saying about `STRING`, but why anonymous?) and `struct hash`?

---
Observation: I try to build a single c program that includes all the logic inside the error message for `OFS->ptr = (PTR) new_STRING(" ");`. Although all functions and logics that are used by `ORS->ptr = (PTR) new_STRING(" ");` is included. However, `kcc` succeeded in running this program.

---
For the error related to `arc4random_push`, it is also reported in the build stage. Here `kcc` is mainly complaining that it couldn't find how the function `mawk_srand()` is defined. 

Line 805 where the error occurs is
```c
...
#ifdef USE_SYSTEM_SRAND
    seed = d_to_i(cseed.dval);
    mawk_srand((unsigned) seed);               // Line 805, error here
#else
    ...
#endif
...
```
Here `mawk_srand` is a macro defined in `config.h`. The interesting thing is that, `config.h` is auto-generated after executing `./configure` (for `kcc`, `./configure CC=kcc LD=kcc`). However, in the `config.h` generated by `gcc`, we have
```c
#define mawk_rand random
#define mawk_srand srandom
```
but `kcc` gives
```c
#define mawk_rand arc4random
#define mawk_srand arc4random_push
```
`random` and `srandom` seems to be standard library functions, but we failed to trace the definition of `arc4random` by using the tracing function of VS Code. Clues for finding `arc4random` inside this project are following:
```c
bi_func.c:

...
#if defined(mawk_srand) || defined(mawk_rand)
#define USE_SYSTEM_SRAND
#endif

#if defined(HAVE_BSD_STDLIB_H) && defined(USE_SYSTEM_SRAND)
#include <bsd/stdlib.h>		/* prototype arc4random */
#endif
...

```
```shell
configure:

...
cf_cv_srand_func=unknown
for cf_func in arc4random_push/arc4random arc4random_stir/arc4random srandom/random srand48/lrand48 srand/rand
do

	cf_srand_func=`echo $cf_func | sed -e 's%/.*%%'`
	cf_rand_func=`echo $cf_func | sed -e 's%.*/%%'`

	case $cf_srand_func in
	(arc4random_stir)
		cf_srand_func='(void)'
		;;
	esac
...
```
After manually changing the macros in `config.h` for `kcc` to use `random` and `srandom`, we observe that if we run `../mawk -f wc.awk mawktest.dat`, 
the error message `Execution failed (configuration dumped)` disappeared. After reporting a bunch of `Type of lvalue not compatible` errors (to much to be displayed here), it stoped by reporting this error:
```
Fatal error: exception (Invalid_argument
  "convert_byte_to_native: encodedValue(opaque(#token(\"2\", \"Int\"), ut(`.Set`(.KList), structType(tag(`Identifier`(#token(\"\\\"_IO_FILE\\\"\", \"String\")), #token(\"\\\"/opt/rv-match/c-semantics/profiles/x86_64-linux-gcc-glibc/src/kcc_types.c55777c10-8fd5-11ea-9420-aad0e96ca077\\\"\", \"String\"), `global_C-TYPING-SYNTAX`(.KList))))), #token(\"0\", \"Int\"), #token(\"8\", \"Int\"))")
```
This message seems to contain semantics of K.

---
Observation: after replacing the `config.h` of `kcc` with that generated by `gcc`, `kcc` succeeded in running `./mawk -W help` which prints out the usage of mawk, while still a lot of `lvalue` warnings are printed.